<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data - Zerodha Kite API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0d1117 100%);
            min-height: 100vh;
            color: #c9d1d9;
        }
        .navbar {
            backdrop-filter: blur(15px);
            background: rgba(0, 0, 0, 0.9) !important;
            border-bottom: 1px solid #30363d;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: #58a6ff !important;
        }
        .nav-link {
            color: #c9d1d9 !important;
            transition: color 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            color: #58a6ff !important;
        }
        .data-table { 
            background: rgba(13, 17, 23, 0.9); 
            border-radius: 15px; 
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #30363d;
        }
        .table th { 
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%); 
            border-top: none; 
            color: #58a6ff;
            font-weight: 600;
        }
        .table td {
            color: #c9d1d9;
            border-color: #30363d;
            background: rgba(13, 17, 23, 0.3);
        }
        .table-hover tbody tr:hover {
            background: rgba(88, 166, 255, 0.1) !important;
        }
        .search-container { 
            background: rgba(13, 17, 23, 0.9); 
            padding: 25px; 
            border-radius: 15px; 
            margin-bottom: 25px; 
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
        .price-positive { color: #7ee787; font-weight: 600; }
        .price-negative { color: #ff7b72; font-weight: 600; }
        .volume-badge { background: linear-gradient(45deg, #58a6ff, #7c3aed); }
        .card {
            border: 1px solid #30363d;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            background: rgba(13, 17, 23, 0.9);
            color: #c9d1d9;
        }
        .card-header {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%);
            color: #58a6ff;
            border-bottom: 1px solid #30363d;
        }
        .display-5 {
            font-weight: 700;
            background: linear-gradient(135deg, #58a6ff 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #30363d;
        }
        .btn-primary, .btn-outline-primary {
            background: linear-gradient(135deg, #58a6ff 0%, #7c3aed 100%);
            border-color: #58a6ff;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.4);
        }
        .btn-primary:hover, .btn-outline-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.6);
            border-color: #58a6ff;
            color: #ffffff;
        }
        .btn-outline-secondary {
            color: #c9d1d9;
            border-color: #30363d;
            background: transparent;
        }
        .btn-outline-secondary:hover {
            background: #30363d;
            color: #ffffff;
        }
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        .text-primary {
            color: #58a6ff !important;
        }
        .text-muted {
            color: #8b949e !important;
        }
        .text-success {
            color: #7ee787 !important;
        }
        .text-danger {
            color: #ff7b72 !important;
        }
        .bg-primary {
            background: linear-gradient(135deg, #58a6ff 0%, #7c3aed 100%) !important;
        }
        .bg-info {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%) !important;
            color: #58a6ff;
        }
        .bg-light {
            background: #21262d !important;
            color: #c9d1d9;
        }
        .badge {
            border-radius: 6px;
            font-weight: 500;
        }
        .badge.bg-secondary {
            background: #30363d !important;
            color: #c9d1d9;
        }
        .badge.bg-success {
            background: #238636 !important;
            color: #ffffff;
        }
        .badge.bg-info {
            background: #1f6feb !important;
            color: #ffffff;
        }
        .form-control, .form-select {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
        .form-control:focus, .form-select:focus {
            background: #161b22;
            border-color: #58a6ff;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(88, 166, 255, 0.25);
        }
        .pagination .page-link {
            background: #0d1117;
            border-color: #30363d;
            color: #58a6ff;
        }
        .pagination .page-link:hover {
            background: #161b22;
            border-color: #58a6ff;
            color: #58a6ff;
        }
        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, #58a6ff 0%, #7c3aed 100%);
            border-color: #58a6ff;
            color: #ffffff;
        }
        .pagination .page-item.disabled .page-link {
            background: #0d1117;
            border-color: #30363d;
            color: #6e7681;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #c9d1d9;
        }
        .animation-fadeIn {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .table-dark {
            background: #161b22;
            color: #c9d1d9;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background: rgba(88, 166, 255, 0.05);
        }
        .alert {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            border-radius: 12px;
        }
        .alert-dismissible .btn-close {
            filter: invert(1);
        }
        .sortable:hover {
            background: rgba(88, 166, 255, 0.2) !important;
        }
        .sort-icon {
            color: #8b949e;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }
        .sort-icon:hover {
            color: #58a6ff;
        }
        .sort-asc {
            color: #7ee787 !important;
        }
        .sort-desc {
            color: #ff7b72 !important;
        }
        .sorting-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #58a6ff 0%, #7c3aed 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: none;
        }
        /* Sorting indicator styles */
        .sorting-indicator {
            position: absolute;
            top: -50px;
            right: 20px;
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced sortable header styles */
        .sortable:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .sortable.sort-asc {
            background-color: rgba(40, 167, 69, 0.2) !important;
        }

        .sortable.sort-desc {
            background-color: rgba(220, 53, 69, 0.2) !important;
        }

        .sort-icons .fas {
            transition: all 0.2s ease;
        }

        .sortable:hover .sort-icons .fas {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'index' %}">
                <i class="fas fa-chart-line me-2"></i>Kite Stock Data
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="{% url 'index' %}"><i class="fas fa-home me-1"></i>Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{% url 'data_view' %}"><i class="fas fa-database me-1"></i>Data</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'settings' %}"><i class="fas fa-cog me-1"></i>Settings</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-database text-primary me-2"></i>Stock Data Files</h1>
            <a href="{% url 'index' %}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Fetch New Data
            </a>
        </div>

        <!-- File Selection -->
        <div class="search-container animation-fadeIn">
            <h5><i class="fas fa-folder-open me-2 text-primary"></i>Available Data Files</h5>
            {% if available_files %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Date Range</th>
                                <th>Interval</th>
                                <th>Records</th>
                                <th>File Size</th>
                                <th>Fetched At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in available_files %}
                            <tr {% if file.filename == selected_file %}class="table-primary"{% endif %}>
                                <td><strong class="text-primary">{{ file.symbol }}</strong></td>
                                <td>
                                    <small>{{ file.from_date }} to {{ file.to_date }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ file.interval }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ file.total_records|floatformat:0 }}</span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ file.file_size|filesizeformat }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ file.fetched_at|slice:":19"|date:"M d, H:i" }}</small>
                                </td>
                                <td>
                                    <a href="?file={{ file.filename }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h5>No Data Files Found</h5>
                    <p class="text-muted">Start by fetching some stock data from the dashboard.</p>
                    <a href="{% url 'index' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Fetch Data
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Data Content -->
        {% if data_content %}
        <div class="data-table mt-4" style="position: relative;">
            <div class="sorting-indicator" id="sorting-indicator">
                <i class="fas fa-sort-amount-down me-1"></i>
                <span id="sort-text">Sorting...</span>
            </div>
            <div class="card-header bg-info text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            {{ data_content.metadata.symbol }} - {{ data_content.metadata.interval|title }} Data
                        </h5>
                        <small>{{ data_content.metadata.from_date }} to {{ data_content.metadata.to_date }}</small>
                    </div>
                    <div class="col-auto">
                        <span class="badge bg-light text-dark">
                            {{ data_content.metadata.total_records }} total records
                        </span>
                        <button class="btn btn-sm btn-outline-light ms-2" onclick="resetSort()" id="reset-sort-btn" style="display: none;">
                            <i class="fas fa-undo me-1"></i>Reset Sort
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Pagination Controls (Top) -->
            {% if pagination.total_pages > 1 %}
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col">
                        <small class="text-muted">
                            Showing {{ pagination.start_record }}-{{ pagination.end_record }} of {{ pagination.total_records }} records
                        </small>
                    </div>
                    <div class="col-auto">
                        <div class="btn-group" role="group">
                            {% if pagination.has_previous %}
                                <a href="?file={{ selected_file }}&page={{ pagination.previous_page }}&per_page={{ pagination.per_page }}" 
                                   class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            {% endif %}
                            
                            <span class="btn btn-outline-secondary btn-sm disabled">
                                Page {{ pagination.current_page }} of {{ pagination.total_pages }}
                            </span>
                            
                            {% if pagination.has_next %}
                                <a href="?file={{ selected_file }}&page={{ pagination.next_page }}&per_page={{ pagination.per_page }}" 
                                   class="btn btn-outline-secondary btn-sm">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            {% endif %}
                        </div>
                        
                        <select class="form-select form-select-sm d-inline-block w-auto ms-2" onchange="changePerPage(this.value)">
                            <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50 per page</option>
                            <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100 per page</option>
                            <option value="250" {% if pagination.per_page == 250 %}selected{% endif %}>250 per page</option>
                            <option value="500" {% if pagination.per_page == 500 %}selected{% endif %}>500 per page</option>
                        </select>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 sortable-table">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable" data-column="date" style="cursor: pointer; user-select: none;" onclick="sortTable('date')">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>Date & Time</span>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort text-muted"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-column="open" style="cursor: pointer; user-select: none;" onclick="sortTable('open')">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>Open</span>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort text-muted"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-column="high" style="cursor: pointer; user-select: none;" onclick="sortTable('high')">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>High</span>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort text-muted"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-column="low" style="cursor: pointer; user-select: none;" onclick="sortTable('low')">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>Low</span>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort text-muted"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-column="close" style="cursor: pointer; user-select: none;" onclick="sortTable('close')">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>Close</span>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort text-muted"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-column="volume" style="cursor: pointer; user-select: none;" onclick="sortTable('volume')">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>Volume</span>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort text-muted"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-column="change" style="cursor: pointer; user-select: none;" onclick="sortTable('change')">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>Change</span>
                                        <div class="sort-icons">
                                            <i class="fas fa-sort text-muted"></i>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            {% for record in data_content.records %}
                            <tr>
                                <td>
                                    <strong>{{ record.date|slice:":10" }}</strong><br>
                                    <small class="text-muted">{{ record.date|slice:"11:19" }}</small>
                                </td>
                                <td>₹{{ record.open|floatformat:2 }}</td>
                                <td class="text-success">₹{{ record.high|floatformat:2 }}</td>
                                <td class="text-danger">₹{{ record.low|floatformat:2 }}</td>
                                <td><strong>₹{{ record.close|floatformat:2 }}</strong></td>
                                <td>
                                    <span class="badge bg-info">{{ record.volume|floatformat:0 }}</span>
                                </td>
                                <td class="change-cell" data-open="{{ record.open }}" data-close="{{ record.close }}">
                                    <span class="text-muted">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Calculating...
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination Controls (Bottom) -->
            {% if pagination.total_pages > 1 %}
            <div class="card-footer bg-light">
                <div class="row align-items-center">
                    <div class="col">
                        <small class="text-muted">
                            Page {{ pagination.current_page }} of {{ pagination.total_pages }} 
                            ({{ pagination.total_records }} total records)
                        </small>
                    </div>
                    <div class="col-auto">
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                {% if pagination.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?file={{ selected_file }}&page=1&per_page={{ pagination.per_page }}">First</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?file={{ selected_file }}&page={{ pagination.previous_page }}&per_page={{ pagination.per_page }}">Previous</a>
                                    </li>
                                {% endif %}
                                
                                <li class="page-item active">
                                    <span class="page-link">{{ pagination.current_page }}</span>
                                </li>
                                
                                {% if pagination.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?file={{ selected_file }}&page={{ pagination.next_page }}&per_page={{ pagination.per_page }}">Next</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?file={{ selected_file }}&page={{ pagination.total_pages }}&per_page={{ pagination.per_page }}">Last</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Table sorting functionality
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        const originalData = [];

        function calculateChangeValues() {
            const changeCells = document.querySelectorAll('.change-cell');
            changeCells.forEach(cell => {
                const openPrice = parseFloat(cell.dataset.open);
                const closePrice = parseFloat(cell.dataset.close);
                
                if (!isNaN(openPrice) && !isNaN(closePrice)) {
                    const change = closePrice - openPrice;
                    const changePercent = ((change / openPrice) * 100);
                    
                    let html = '';
                    if (change > 0) {
                        html = `<span class="text-success">
                                    <i class="fas fa-arrow-up me-1"></i>+${change.toFixed(2)} 
                                    <small>(+${changePercent.toFixed(2)}%)</small>
                                </span>`;
                    } else if (change < 0) {
                        html = `<span class="text-danger">
                                    <i class="fas fa-arrow-down me-1"></i>${change.toFixed(2)} 
                                    <small>(${changePercent.toFixed(2)}%)</small>
                                </span>`;
                    } else {
                        html = `<span class="text-muted">
                                    <i class="fas fa-minus me-1"></i>0.00 
                                    <small>(0.00%)</small>
                                </span>`;
                    }
                    cell.innerHTML = html;
                } else {
                    cell.innerHTML = '<span class="text-muted"><i class="fas fa-minus me-1"></i>N/A</span>';
                }
            });
        }

        function initializeData() {
            const table = document.querySelector('.sortable-table tbody');
            if (!table) return;
            
            // Store original data order
            originalData.length = 0;
            const rows = Array.from(table.querySelectorAll('tr'));
            rows.forEach(row => {
                originalData.push(row.cloneNode(true));
            });
        }

        function sortTable(column) {
            console.log('Sorting by column:', column);
            const table = document.querySelector('.sortable-table tbody');
            if (!table) {
                console.error('Table not found!');
                return;
            }

            const rows = Array.from(table.querySelectorAll('tr'));
            const headerCells = document.querySelectorAll('.sortable');
            
            console.log('Found rows:', rows.length);
            console.log('Found headers:', headerCells.length);
            
            // Determine sort direction
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Update header icons
            headerCells.forEach(header => {
                const icon = header.querySelector('i');
                if (header.dataset.column === column) {
                    if (currentSortDirection === 'asc') {
                        icon.className = 'fas fa-sort-up text-success';
                        header.classList.remove('sort-desc');
                        header.classList.add('sort-asc');
                    } else {
                        icon.className = 'fas fa-sort-down text-danger';
                        header.classList.remove('sort-asc');
                        header.classList.add('sort-desc');
                    }
                } else {
                    icon.className = 'fas fa-sort text-muted';
                    header.classList.remove('sort-asc', 'sort-desc');
                }
            });

            // Show sorting indicator
            showSortingIndicator(column, currentSortDirection);

            // Sort rows based on column
            const columnIndex = getColumnIndex(column);
            console.log('Column index for', column, ':', columnIndex);
            if (columnIndex === -1) return;

            rows.sort((a, b) => {
                let aValue, bValue;
                
                // Special handling for change column
                if (column === 'change') {
                    const aChangeCell = a.cells[columnIndex];
                    const bChangeCell = b.cells[columnIndex];
                    const aOpen = parseFloat(aChangeCell.dataset.open);
                    const aClose = parseFloat(aChangeCell.dataset.close);
                    const bOpen = parseFloat(bChangeCell.dataset.open);
                    const bClose = parseFloat(bChangeCell.dataset.close);
                    
                    aValue = aClose - aOpen;
                    bValue = bClose - bOpen;
                } else {
                    aValue = getCellValue(a, columnIndex);
                    bValue = getCellValue(b, columnIndex);
                }
                
                let comparison = 0;
                if (isNumeric(aValue) && isNumeric(bValue)) {
                    comparison = parseFloat(aValue) - parseFloat(bValue);
                } else {
                    comparison = String(aValue).localeCompare(String(bValue));
                }
                
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            // Update table
            table.innerHTML = '';
            rows.forEach(row => table.appendChild(row));

            // Recalculate change values after sorting
            calculateChangeValues();

            // Show reset button
            const resetBtn = document.getElementById('reset-sort-btn');
            if (resetBtn) resetBtn.style.display = 'inline-block';
            
            console.log('Sorting completed');
        }

        function getColumnIndex(column) {
            const headers = document.querySelectorAll('.sortable-table th');
            for (let i = 0; i < headers.length; i++) {
                const sortable = headers[i].querySelector('.sortable');
                if (sortable && sortable.dataset.column === column) {
                    return i;
                }
            }
            return -1;
        }

        function getCellValue(row, index) {
            const cell = row.cells[index];
            if (!cell) return '';
            
            // Extract numeric value from cells with currency symbols or formatting
            let textContent = cell.textContent.trim();
            
            // Remove currency symbols and extract numbers
            if (textContent.includes('₹')) {
                textContent = textContent.replace('₹', '').replace(/,/g, '');
            }
            
            // For date column, return the date part for sorting
            if (index === 0) {
                const dateMatch = textContent.match(/\d{4}-\d{2}-\d{2}/);
                if (dateMatch) return dateMatch[0];
            }
            
            return textContent;
        }

        function isNumeric(value) {
            return !isNaN(parseFloat(value)) && isFinite(value);
        }

        function showSortingIndicator(column, direction) {
            const indicator = document.getElementById('sorting-indicator');
            const sortText = document.getElementById('sort-text');
            const icon = indicator.querySelector('i');
            
            if (direction === 'asc') {
                icon.className = 'fas fa-sort-amount-up me-1 text-success';
                sortText.textContent = `Sorted by ${column.replace('_', ' ')} (A-Z)`;
            } else {
                icon.className = 'fas fa-sort-amount-down me-1 text-danger';
                sortText.textContent = `Sorted by ${column.replace('_', ' ')} (Z-A)`;
            }
            
            indicator.style.display = 'block';
            
            // Hide after 3 seconds
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function resetSort() {
            const table = document.querySelector('.sortable-table tbody');
            if (!table || originalData.length === 0) return;

            // Reset table to original order
            table.innerHTML = '';
            originalData.forEach(row => {
                table.appendChild(row.cloneNode(true));
            });

            // Reset header icons
            const headerCells = document.querySelectorAll('.sortable');
            headerCells.forEach(header => {
                const icon = header.querySelector('i');
                icon.className = 'fas fa-sort text-muted';
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // Reset state
            currentSortColumn = null;
            currentSortDirection = 'asc';

            // Hide reset button and indicator
            document.getElementById('reset-sort-btn').style.display = 'none';
            document.getElementById('sorting-indicator').style.display = 'none';
        }

        function changePerPage(perPage) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('per_page', perPage);
            urlParams.set('page', '1'); // Reset to first page
            window.location.search = urlParams.toString();
        }

        function exportData() {
            // Future implementation for CSV export
            alert('CSV export feature will be implemented soon!');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            calculateChangeValues();
        });

        // Auto-refresh data every 5 minutes if viewing live data
        {% if selected_file %}
        setInterval(function() {
            // Could implement auto-refresh logic here
        }, 300000); // 5 minutes
        {% endif %}
    </script>
</body>
</html>
